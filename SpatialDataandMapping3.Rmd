---
title: "SpatialData_and_Mapping"
output: html_document
editor_options: 
  chunk_output_type: console
---
---
title: "SpatialData_and_Mapping"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{R - Install Packages}
packages<-c("sf", "raster", "rgdal", "rgeos", "sp", "tidyverse", "rmarkdown","RColorBrewer")

package.check <- lapply(packages,FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)}})

# clean environment
rm(packages)
```

# Working off of Local desktop GIS workspace using Github repository
```{r - Set Working Directory}
# Make sure working directory is automatically set to your local github folder
getwd()

```

Vector data consists of points, lines, and/or polygons with spatial coordinates
# Load Vector Data
```{r - Load Vector Data}

# Read in dataset of leafy spurge presence points in Fremont Co, WY
SpurgeFull <- readOGR(dsn = ".", layer = "SpurgeFull")
study_area <- readOGR(dsn = ".", layer = "StudyArea")
FremontMRoads <- readOGR(dsn = ".", layer = "FremontMainRoads")
FremontWater <- readOGR(dsn = ".", layer = "WaterwaysFremont")
FremontCo <- readOGR(dsn = ".", layer = "FremontCo")
head(SpurgeFull)
head(study_area)
head(FremontMRoads)
head(FremontWater)
head(FremontCo)

table(is.na(SpurgeFull$Latitude))# must be FALSE here! No TRUES. 
table(is.na(SpurgeFull$Longitude))# must be FALSE here! No TRUES. 

# Plot dataset. May take a bit
plot(SpurgeFull)
# Not that informative, add some spatial context with Fremont Co border and a plot again
```

# What is the projection that your data are in? Figure this out and specify below. Specify at least 2 different fuctions you can use to check this.
** ** 

``` {r - Projection Systems}
# First, check coordinate system and projection, otherwise these will not align when plotting
proj4string(SpurgeFull)
proj4string(study_area)
proj4string(FremontMRoads)
proj4string(FremontWater)
proj4string(FremontCo)
```

#Change the projection sysmtes so that all data has the same CRS.
```{r - Projection}
proj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
SpurgeFull <- spTransform(SpurgeFull, CRS(proj))
study_area <- spTransform(study_area, CRS(proj))
FremontMRoads <- spTransform(FremontMRoads, CRS(proj))
FremontWater <- spTransform(FremontWater, CRS(proj))
FremontCo <- spTransform(FremontCo, CRS(proj))

# make sure all projections line up
proj4string(SpurgeFull)
proj4string(study_area)
proj4string(FremontMRoads)
proj4string(FremontWater)
proj4string(FremontCo)
# perfect!
```

#Can you think of other ways to make sure projection systems are the same? List 1 other way.
** **
``` {r - Projections}

#you can try 
identical(crs(SpurgeFull),crs(study_area))
identicalCRS(SpurgeFull,study_area)
```


```{r - Plotting}
# Plot datasets to make sure they line up. May take a bit
plot(SpurgeFull)
plot(FremontCo, add = T, border = "red")
plot(FremontWater, add = T, border = "blue")
plot(FremontMRoads, add = T, border = "grey")

# You might notice some issues! Don't worry, we'll get to those!
# First let's zoom in a bit to help with processing time while we learn the processes involved in plotting spatial data in ggplot.

# First lets clip the data to only look at Lander/Riverton area
FremontMRoads <- FremontMRoads[study_area,]
SpurgeFull <- SpurgeFull[study_area,]
FremontWater <- FremontWater[study_area,]

# Check to make sure it worked
plot(SpurgeFull)
plot(study_area, add = T, border = "red")
plot(FremontWater, add = T, border = "blue")
plot(FremontMRoads, add = T, border = "grey")
```

# Why do the roads and rivers still extend outside the study area polygon?
** ** 

```{r - Cleaning up plots}
# Lets make a cleaner version of the intersections between the study area and our water and roads
FremontWater <- gIntersection(FremontWater, study_area)
FremontMRoads <- gIntersection(FremontMRoads, study_area)

plot(SpurgeFull)
plot(study_area, add = T, border = "red")
plot(FremontWater, add = T, border = "blue")
plot(FremontMRoads, add = T, border = "grey")
```

# What has changed in the data? 
# hint:look at length of some features.
** ** 


```{r - Spatial maps in ggplot}

# Have to fortify to plot with ggplot
FremontMRoadsF <- fortify(FremontMRoads)
study_areaF <- fortify(study_area)
SpurgeFullF <- fortify(SpurgeFull)
FremontWaterF <- fortify(FremontWater)
FremontCoF <- fortify(FremontCo)

# Plot spurge and Fremont country to continue to get oriented
ggplot() +
  geom_polygon(data = FremontCoF, aes(x=long, y=lat), fill = NA, color = "black") +
  geom_polygon(data = SpurgeFullF, aes(x=long, y=lat, group = group), fill = "NA", color ="green")+
  theme_minimal()+
  labs(x="",y="")+
  theme(panel.grid=element_blank(), axis.text=element_blank())


# Plot data sets with new clipped extent (just our study area)
ggplot() +
  geom_polygon(data = study_areaF, aes(x=long, y=lat), fill = NA, color = "black") +
  geom_polygon(data = FremontWaterF, aes(x=long, y=lat, group = group), fill = "blue", color = "blue" ) +    
  geom_polygon(data = SpurgeFullF, aes(x=long, y=lat, group = group), fill = "yellow", color = "yellow" ) +    
  geom_line(data = FremontMRoadsF, aes(x=long, y=lat, group = group), color = "black" ) +
  theme_minimal()+
  labs(x="", y="")+
  theme(panel.grid = element_blank(), axis.text = element_blank())

```


# Raster data is made up of a grid of pixels filled with values. These can be continuous variables like elevation, thematic values like landcover, or reflectance values like remote sensing imagery. 
```{r - Raster Data}
# For this project, we have one continuous topographic raster and one thematic landcover raster

# Import elevation
Elevation <- raster("elev_output.tif")

# Import GAP landcover data
GAPCover <- raster("GAP_output.tif")
# Alright, all data is in!

# What to we need to do to make sure things will line up?
proj4string(Elevation)
proj4string(GAPCover)
# all looks great!

```

# Crop/Mask Raster Data
```{r Plot all data into one lovely map! ,message=F}

# we are going to clip our rasters to match the clipped extent of our other data.
# We have two rasters for you to play with, Elevation, and GAP Cover. 
Elevation.c <- crop(Elevation, study_area)
GAPCover.c <- crop(GAPCover, study_area)
```

# Take a look at the raster data again, why do we have to mask it?
** **
  
```{r - Plot Raster Data ,message=F}
plot(Elevation)
plot(Elevation.c)
plot(GAPCover)
plot(GAPCover.c)
```

```{r - Plot all data types together in ggplot}
#Lets start with plotting GAPCover.

#We  need to convert GAP landcover data from a raster to points to use in ggplot
map.p <- rasterToPoints(GAPCover.c)
df <- data.frame(map.p)

#Make appropriate column headings
colnames(df)<-c("Longitude", "Latitude", "GAPCover")
df<-fortify(df)

#GAPCover map - you'll have to give this a minute or two to plot!
ggplot(df, aes(y=Latitude, x=Longitude)) +
  geom_raster(aes(fill=GAPCover))+
  theme_minimal()+
  geom_polygon(data=study_areaF, aes(x=long, y=lat),color = "black", fill="NA", size=1)+
  theme(panel.grid = element_blank(), axis.text = element_blank())+
  labs(x="", y="")+
  scale_fill_gradientn(colours=brewer.pal(9, "RdPu"))+
  geom_polygon(data = FremontWaterF, aes(x=long, y=lat, group = group), color = "blue")+
  geom_line(data = FremontMRoadsF, aes(x=long, y=lat, group = group), color = "black")+
  geom_polygon(data = SpurgeFullF, aes(x=long, y=lat, group = group), color ="chartreuse")

#need a legend.. 
```


#We are looking at a very zoomed in area. Imagine you want to compare your study area to the rest of Fremont County. 
```{r - Lets try changing the extent to which our map is bound ,message=F}

#Re-read in your spatial data
GAPCover <- raster("GAP_output.tif")
SpurgeFull <- readOGR(dsn = ".", layer = "SpurgeFull")
FremontMRoads <- readOGR(dsn = ".", layer = "FremontMainRoads")
FremontWater <- readOGR(dsn = ".", layer = "WaterwaysFremont")
FremontCo <- readOGR(dsn = ".", layer = "FremontCo")

#Make sure the projection system is set!
proj <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
SpurgeFull <- spTransform(SpurgeFull, CRS(proj))
FremontMRoads <- spTransform(FremontMRoads, CRS(proj))
FremontWater <- spTransform(FremontWater, CRS(proj))
FremontCo <- spTransform(FremontCo, CRS(proj))

#With raster data, you can use mask or crop to cut it down. In this case we are going to mask our raster down to the size of Fremont County to get a moew zoomed-out view of our data.
```


#We know we need to mask/crop the GAPCover raster, but what other data do we need to crop? Take a look below.
** ** 
```{r - Check out data again}
plot(FremontCo)
plot(GAPCover, add=T, alpha=.4) #yes
plot(SpurgeFull, add=T, color="green") #yes
plot(FremontMRoads, add=T)#no
plot(FremontWater, add=T, color="blue") #yes
```

# You may have noticed, we need to crop the raster, SprugeFull, and FremontWater. Let's clean up our data. 
```{r - Plot GAPCover for all of Fremont County}
  
  #We will mask our raster and then convert it into points, which must be done to plot with ggplot.
  GAPCover<-mask(GAPCover,FremontCo)
  map.p <- rasterToPoints(GAPCover)
  gap.df <- data.frame(map.p)
  
  #Make appropriate column headings
  colnames(gap.df)<-c("Longitude", "Latitude", "GAPCover")
  gap.df<-fortify(gap.df)
  
  #crop water and spurge to just Fremont Co
  FremontWater<-crop(FremontWater,FremontCo)
  SpurgeFull<-crop(SpurgeFull,FremontCo)
  
  #fortify all for ggplot
  FremontWaterF <- fortify(FremontWater)
  SpurgeFullF <- fortify(SpurgeFull)
  FremontMRoadsF<-fortify(FremontMRoads)
  gap.df.f<-fortify(gap.df)
  FremontCo.F<-fortify(FremontCo)
  
  #plot all together!
  ggplot(gap.df.f, aes(y=Latitude, x=Longitude)) +
    geom_raster(aes(fill=GAPCover))+
    theme_minimal()+
    geom_polygon(data=FremontCoF, aes(x=long, y=lat),color = "black", fill="NA", size=1)+
    theme(panel.grid = element_blank(), axis.text = element_blank())+
    labs(x="", y="", fill="GAPCover (?)")+
    scale_fill_gradientn(colours=brewer.pal(9, "RdPu"))+
    geom_polygon(data = FremontWaterF, aes(x=long, y=lat, group = group), color = "cadetblue3")+
    geom_line(data = FremontMRoadsF, aes(x=long, y=lat, group = group), color = "black")+
    geom_polygon(data = SpurgeFullF, aes(x=long, y=lat, group = group), color ="chartreuse")
```
  
# Elevation map - all Fremont Co
```{r Plot all data into one lovely map w/ Elevation,message=F}
  
  # You can do this for Elevation too, if you're interested, but 1st mask it first to Fremont Co!
  Elevation<-mask(Elevation,FremontCo)
  
  #raster to points for ggplot!
  map.p <- rasterToPoints(Elevation)
  elev.df <- data.frame(map.p)
  #Make appropriate column headings
  colnames(df)<-c("Longitude", "Latitude", "Elevation")
  elev.df<-fortify(df)
  
  #Elevation map - you'll have to give this a minute or two to plot!
  ggplot(elev.df, aes(y=Latitude, x=Longitude)) +
    geom_raster(aes(fill=Elevation))+
    geom_polygon(data=FremontCoF, aes(x=long, y=lat),color = "black", fill="NA", size=1)+
    theme_minimal()+
    theme(panel.grid = element_blank(), axis.text = element_blank())+
    labs(x="", y="", fill="Elevation (m)")+
    scale_fill_gradientn(colours=brewer.pal(9, "RdPu"))+
    geom_polygon(data = FremontWaterF, aes(x=long, y=lat, group = group), color = "cadetblue3")+
    geom_line(data = FremontMRoadsF, aes(x=long, y=lat, group = group), color = "black")+
    geom_polygon(data = SpurgeFullF, aes(x=long, y=lat, group = group), color ="chartreuse")
```
